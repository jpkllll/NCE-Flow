<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="NCE Flow">
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <title>清单 - NCE Flow</title>
  <link rel="stylesheet" href="assets/styles.css">

  <script src="assets/utils.js" defer></script>
  <script src="assets/app.js" defer></script>
  <script src="assets/favorites.js" defer></script>

  <!-- 主题切换逻辑 -->
  <script>
    (function () {
      const THEME_KEY = 'nce_theme';
      const SUN_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
      const MOON_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';

      function getPreferredTheme() {
        return localStorage.getItem(THEME_KEY) || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      }

      function applyTheme(theme) {
        const root = document.documentElement;
        const scrollX = window.scrollX || 0;
        const scrollY = window.scrollY || 0;
        root.classList.remove('dark-theme', 'light-theme');
        root.classList.add(theme + '-theme');
        if (document.body) {
          document.body.classList.remove('dark-theme', 'light-theme');
          document.body.classList.add(theme + '-theme');
        }
        try { root.style.colorScheme = theme; } catch (_) { }
        const computedBg = (() => {
          try {
            const base = document.body ? getComputedStyle(document.body) : getComputedStyle(root);
            return base.getPropertyValue('--bg').trim();
          } catch (_) {
            return '';
          }
        })();
        const bg = computedBg || (theme === 'dark' ? '#09090b' : '#ffffff');
        root.style.backgroundColor = bg;
        if (document.body) document.body.style.backgroundColor = bg;
        void root.offsetHeight;
        
        const btn = document.getElementById('themeToggleBtn');
        if (btn) {
          btn.innerHTML = theme === 'dark' ? SUN_ICON : MOON_ICON;
          btn.setAttribute('aria-label', theme === 'dark' ? '切换到浅色模式' : '切换到深色模式');
        }
        if (document.body) {
          requestAnimationFrame(() => {
            // iOS/WKWebView: sometimes tiles don't repaint until a scroll happens.
            const body = document.body;
            const prevOpacity = body.style.opacity;
            body.style.opacity = '0.99999';

            const doc = document.documentElement;
            const maxY = Math.max(0, doc.scrollHeight - window.innerHeight);
            const y0 = Math.max(0, Math.min(scrollY, maxY));
            const y1 = maxY ? (y0 < maxY ? y0 + 1 : Math.max(0, y0 - 1)) : y0;
            window.scrollTo(scrollX, y1);

            requestAnimationFrame(() => {
              body.style.opacity = prevOpacity;
              window.scrollTo(scrollX, y0);
            });
          });
        }
      }

      function toggleTheme() {
        const isDark = document.documentElement.classList.contains('dark-theme') ||
          (document.body && document.body.classList.contains('dark-theme'));
        const next = isDark ? 'light' : 'dark';
        localStorage.setItem(THEME_KEY, next);
        applyTheme(next);
      }

      function init() {
        applyTheme(getPreferredTheme());
        const btn = document.getElementById('themeToggleBtn');
        if (btn) btn.addEventListener('click', toggleTheme);
      }

      if (window.matchMedia) {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        const handleChange = (e) => {
          if (!localStorage.getItem(THEME_KEY)) applyTheme(e.matches ? 'dark' : 'light');
        };
        if (mq.addEventListener) mq.addEventListener('change', handleChange);
        else if (mq.addListener) mq.addListener(handleChange);
      }

      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
      else init();
    })();
  </script>
</head>
<body class="favorites-page">
  <canvas id="bg-canvas"></canvas>
  <div class="container">
    <header class="hero">
      <h1 id="favTitle">清单</h1>
      <p id="favSub" class="muted"></p>
      <div class="seg-wrap">
        <div class="segmented tabs" role="tablist" aria-label="册别">
          <a class="seg" href="index.html#NCE1">第一册</a>
          <a class="seg" href="index.html#NCE2">第二册</a>
          <a class="seg" href="index.html#NCE3">第三册</a>
          <a class="seg" href="index.html#NCE4">第四册</a>
          <a class="seg active" href="favorites.html" aria-current="page">清单</a>
        </div>
      </div>
    </header>

    <div class="toolbar">
      <div class="topbar-inner">
        <a id="backBtn" class="back-inline" href="index.html#NCE1" aria-label="返回">
          <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false"><path fill="currentColor" d="M9.78 3.22a.75.75 0 0 1 0 1.06L6.06 8l3.72 3.72a.75.75 0 1 1-1.06 1.06L4.47 8.53a1.25 1.25 0 0 1 0-1.77l4.25-4.25a.75.75 0 0 1 1.06 0Z"></path></svg>
          返回
        </a>
        <div class="seg-wrap">
          <div id="langTabs" class="segmented tabs" role="tablist" aria-label="语言">
            <button class="seg" data-mode="en" aria-label="英文">EN</button>
            <button class="seg" data-mode="bi" aria-label="双语">EN+CN</button>
            <button class="seg" data-mode="cn" aria-label="中文">CN</button>
          </div>
        </div>
        <div class="topbar-actions">
          <button id="ttsSettingsBtn" class="back-inline" type="button" aria-label="设置" title="设置">设置</button>
        </div>
      </div>
    </div>

    <main>
      <section class="sentences" id="favSentences"></section>
    </main>

    <footer>
      <p class="repo">
        <a class="gh-link" href="https://github.com/luzhenhua/NCE-Flow" target="_blank" rel="noopener" aria-label="GitHub repository">
          <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36 .09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8Z"></path></svg>
        </a>
      </p>
      <p class="byline">Designed &amp; Maintained by <a href="https://luzhenhua.cn/" target="_blank" rel="noopener">Luzhenhua</a></p>
      <p class="version"><a href="https://github.com/luzhenhua/NCE-Flow/releases" target="_blank" rel="noopener">版本 1.7.9</a></p>
      <div class="footer-actions">
        <a class="footer-btn" href="about.html">关于</a>
      </div>
    </footer>
  </div>

  <!-- Bottom TTS bar -->
  <div class="bottom-player-bar" role="region" aria-label="清单播放器">
    <div class="player">
      <div class="custom-player tts-player">
        <button id="ttsPrev" class="play-btn" type="button" aria-label="上一句" title="上一句">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 5h2v14H6V5zm3 7 13 7V5l-13 7z"/></svg>
        </button>
        <button id="ttsPlayPause" class="play-btn" type="button" aria-label="播放/暂停" title="播放/暂停">
          <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
          <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="display:none"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>
        </button>
        <button id="ttsNext" class="play-btn" type="button" aria-label="下一句" title="下一句">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M16 5h2v14h-2V5zM2 12l13 7V5L2 12z"/></svg>
        </button>
        <div class="time-display" id="ttsPos">0/0</div>
      </div>
    </div>
  </div>

  <!-- TTS Settings -->
  <div id="ttsOverlay" class="settings-overlay" hidden></div>
  <div id="ttsPanel" class="settings-panel" role="dialog" aria-modal="true" aria-labelledby="ttsTitle" hidden>
    <div class="settings-header">
      <h2 id="ttsTitle">播放设置</h2>
      <button id="ttsClose" class="icon-btn" aria-label="关闭" title="关闭">
        <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
          <path d="M5 5 L15 15 M15 5 L5 15"></path>
        </svg>
      </button>
    </div>
    <div class="settings-body">
      <div class="settings-group">
        <div class="settings-left">
          <div class="settings-label">循环模式</div>
          <div class="settings-desc">选择是否单句循环或循环整个清单。</div>
        </div>
        <div class="settings-control">
          <select id="ttsLoopSelect" class="tts-select" aria-label="循环模式">
            <option value="off">关（只播放当前一句）</option>
            <option value="one">单句循环</option>
            <option value="all">全清单循环</option>
          </select>
        </div>
      </div>

      <div class="settings-group">
        <div class="settings-left">
          <div class="settings-label">播放速度</div>
          <div class="settings-desc">选择朗读的倍速。</div>
        </div>
        <div class="settings-control">
          <select id="ttsRateSelect" class="tts-select" aria-label="播放速度"></select>
        </div>
      </div>

      <div class="settings-group">
        <div class="settings-left">
          <div class="settings-label">音色</div>
          <div class="settings-desc">不同浏览器/设备音色可能不同。</div>
        </div>
        <div class="settings-control">
          <select id="ttsVoice" class="tts-select" aria-label="音色"></select>
        </div>
      </div>

      <div class="settings-group">
        <div class="settings-left">
          <div class="settings-label">清单</div>
          <div class="settings-desc">清空清单会移除所有已收藏句子。</div>
        </div>
        <div class="settings-control">
          <button id="clearListBtn" class="back-inline" type="button" aria-label="清空清单" title="清空清单">清空清单</button>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Drawer (placeholder, default hidden) -->
  <div id="aiOverlay" class="settings-overlay" hidden></div>
  <div id="aiPanel" class="settings-panel" role="dialog" aria-modal="true" aria-labelledby="aiTitle" hidden>
    <div class="settings-header">
      <h2 id="aiTitle">AI 助手</h2>
      <button id="aiClose" class="icon-btn" aria-label="关闭" title="关闭">
        <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
          <path d="M5 5 L15 15 M15 5 L5 15"></path>
        </svg>
      </button>
    </div>
    <div class="settings-body">
      <div class="settings-group full-width">
        <div class="settings-header-row">
          <div class="settings-label">当前句子</div>
        </div>
        <div id="aiCurrent" class="ai-current"></div>
        <div class="ai-actions">
          <button id="aiCopySentence" class="back-inline" type="button">复制句子</button>
          <button id="aiCopyPrompt" class="back-inline" type="button">复制提示词</button>
        </div>
        <div class="settings-desc" style="margin-top:10px">
          AI 功能后续可接入；目前提供一键复制句子/提示词，方便粘贴到你常用的 AI 工具。
        </div>
      </div>
    </div>
  </div>

  <script>
    // Particle Background Animation
    (function(){
      const cvs = document.getElementById('bg-canvas');
      if (!cvs) return;

      const ctx = cvs.getContext('2d');
      const DPR_CAP = 1.5;
      const TARGET_FPS = 30;
      const FRAME_MS = 1000 / TARGET_FPS;
      const BASE_FRAME_MS = 1000 / 60;
      let particles = [];
      let lastRenderTs = 0;

      function resize(){
        const dpr = Math.min(window.devicePixelRatio || 1, DPR_CAP);
        cvs.width  = Math.floor(innerWidth  * dpr);
        cvs.height = Math.floor(innerHeight * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        cvs.style.width  = innerWidth  + 'px';
        cvs.style.height = innerHeight + 'px';
      }
      window.addEventListener('resize', resize);

      class Particle {
        constructor(){
          this.x = Math.random() * innerWidth;
          this.y = Math.random() * innerHeight;
          this.vx = (Math.random() - .5) * .3;
          this.vy = (Math.random() - .5) * .3;
          this.r = Math.random() * 1.2 + .5;
        }
        update(step){
          this.x += this.vx * step;
          this.y += this.vy * step;
          if(this.x < 0 || this.x > innerWidth) this.vx *= -1;
          if(this.y < 0 || this.y > innerHeight) this.vy *= -1;
        }
        draw(){
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
          ctx.fillStyle = isDark() ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.25)';
          ctx.fill();
        }
      }

      function isDark(){
        return document.body.classList.contains('dark-theme');
      }

      function drawLines(){
        const maxDist = 100;
        const maxDistSq = maxDist * maxDist;
        for(let i=0;i<particles.length;i++){
          for(let j=i+1;j<particles.length;j++){
            const dx = particles[i].x - particles[j].x,
                  dy = particles[i].y - particles[j].y;
            const distSq = dx*dx + dy*dy;
            if(distSq < maxDistSq){
              const dist = Math.sqrt(distSq);
              ctx.beginPath();
              ctx.moveTo(particles[i].x, particles[i].y);
              ctx.lineTo(particles[j].x, particles[j].y);
              ctx.strokeStyle = isDark()
                ? `rgba(255,255,255,${1-dist/maxDist})`
                : `rgba(0,0,0,${.5-dist/(maxDist*2)})`;
              ctx.lineWidth = .5;
              ctx.stroke();
            }
          }
        }
      }

      function init(){
        resize();
        particles = Array.from({length: Math.floor(innerWidth*innerHeight/18000)}, ()=>new Particle());
        requestAnimationFrame(animate);
      }

      function animate(ts){
        requestAnimationFrame(animate);
        if(!lastRenderTs) lastRenderTs = ts;
        const elapsed = ts - lastRenderTs;
        if(elapsed < FRAME_MS) return;
        lastRenderTs = ts - (elapsed % FRAME_MS);

        const step = Math.min(elapsed / BASE_FRAME_MS, 5);
        ctx.clearRect(0,0,innerWidth,innerHeight);
        particles.forEach(p=>{p.update(step);p.draw();});
        drawLines();
      }

      init();
    })();
  </script>
</body>
</html>
