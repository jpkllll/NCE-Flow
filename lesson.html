<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="NCE Flow">
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <title>NCE Flow</title>
  <link rel="stylesheet" href="assets/styles.css">
  <script type="text/javascript">
    (function (c, l, a, r, i, t, y) {
      c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
      t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
      y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
    })(window, document, "clarity", "script", "tvjv632zgs");
  </script>
  <script src="assets/utils.js" defer></script>
  <script src="assets/app.js" defer></script>
  <script src="assets/lesson.js" defer></script>

  <!-- ä¸»é¢˜åˆ‡æ¢é€»è¾‘ -->
  <script>
    (function () {
      const THEME_KEY = 'nce_theme';
      const SUN_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
      const MOON_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';

      function getPreferredTheme() {
        return localStorage.getItem(THEME_KEY) || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      }

      function applyTheme(theme) {
        const root = document.documentElement;
        const scrollX = window.scrollX || 0;
        const scrollY = window.scrollY || 0;
        root.classList.remove('dark-theme', 'light-theme');
        root.classList.add(theme + '-theme');
        if (document.body) {
          document.body.classList.remove('dark-theme', 'light-theme');
          document.body.classList.add(theme + '-theme');
        }
        try { root.style.colorScheme = theme; } catch (_) { }
        const computedBg = (() => {
          try {
            const base = document.body ? getComputedStyle(document.body) : getComputedStyle(root);
            return base.getPropertyValue('--bg').trim();
          } catch (_) {
            return '';
          }
        })();
        const bg = computedBg || (theme === 'dark' ? '#09090b' : '#ffffff');
        root.style.backgroundColor = bg;
        if (document.body) document.body.style.backgroundColor = bg;
        void root.offsetHeight;

        const btn = document.getElementById('themeToggleBtn');
        if (btn) {
          btn.innerHTML = theme === 'dark' ? SUN_ICON : MOON_ICON;
          btn.setAttribute('aria-label', theme === 'dark' ? 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼');
        }
        if (document.body) {
          requestAnimationFrame(() => {
            // iOS/WKWebView: sometimes tiles don't repaint until a scroll happens.
            const body = document.body;
            const prevOpacity = body.style.opacity;
            body.style.opacity = '0.99999';

            const doc = document.documentElement;
            const maxY = Math.max(0, doc.scrollHeight - window.innerHeight);
            const y0 = Math.max(0, Math.min(scrollY, maxY));
            const y1 = maxY ? (y0 < maxY ? y0 + 1 : Math.max(0, y0 - 1)) : y0;
            window.scrollTo(scrollX, y1);

            requestAnimationFrame(() => {
              body.style.opacity = prevOpacity;
              window.scrollTo(scrollX, y0);
            });
          });
        }
      }

      function toggleTheme() {
        const isDark = document.documentElement.classList.contains('dark-theme') ||
          (document.body && document.body.classList.contains('dark-theme'));
        const next = isDark ? 'light' : 'dark';
        localStorage.setItem(THEME_KEY, next);
        applyTheme(next);
      }

      function init() {
        applyTheme(getPreferredTheme());
        const btn = document.getElementById('themeToggleBtn');
        if (btn) btn.addEventListener('click', toggleTheme);
      }

      if (window.matchMedia) {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        const handleChange = (e) => {
          if (!localStorage.getItem(THEME_KEY)) applyTheme(e.matches ? 'dark' : 'light');
        };
        if (mq.addEventListener) mq.addEventListener('change', handleChange);
        else if (mq.addListener) mq.addListener(handleChange);
      }

      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
      else init();
    })();
  </script>
</head>

<body class="lesson-page">
  <canvas id="bg-canvas"></canvas>
  <div class="container">
    <header class="hero">
      <h1 id="lessonTitle">è¯¾æ–‡</h1>
      <p id="lessonSub" class="muted"></p>
    </header>
    <div class="toolbar">
      <div class="topbar-inner">
        <a id="backLink" class="back-inline" href="#" aria-label="é¦–é¡µ">
          <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
            <path fill="currentColor"
              d="M9.78 3.22a.75.75 0 0 1 0 1.06L6.06 8l3.72 3.72a.75.75 0 1 1-1.06 1.06L4.47 8.53a1.25 1.25 0 0 1 0-1.77l4.25-4.25a.75.75 0 0 1 1.06 0Z">
            </path>
          </svg>
          é¦–é¡µ
        </a>
        <div class="seg-wrap">
          <div id="langTabs" class="segmented tabs" role="tablist" aria-label="è¯­è¨€">
            <button class="seg" data-mode="en" aria-label="è‹±æ–‡">EN</button>
            <button class="seg" data-mode="bi" aria-label="åŒè¯­">EN+CN</button>
            <button class="seg" data-mode="cn" aria-label="ä¸­æ–‡">CN</button>
          </div>
        </div>
        <div class="topbar-actions">
          <button id="settingsBtn" class="back-inline" aria-label="è®¾ç½®" title="è®¾ç½®">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor"
              stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
              <path
                d="M9.59356 3.94014C9.68397 3.39768 10.1533 3.00009 10.7033 3.00009H13.2972C13.8472 3.00009 14.3165 3.39768 14.4069 3.94014L14.6204 5.22119C14.6828 5.59523 14.9327 5.9068 15.2645 6.09045C15.3387 6.13151 15.412 6.17393 15.4844 6.21766C15.8095 6.41393 16.2048 6.47495 16.5604 6.34175L17.7772 5.88587C18.2922 5.69293 18.8712 5.9006 19.1462 6.37687L20.4432 8.6233C20.7181 9.09957 20.6085 9.70482 20.1839 10.0544L19.1795 10.8812C18.887 11.122 18.742 11.4938 18.7491 11.8726C18.7498 11.915 18.7502 11.9575 18.7502 12.0001C18.7502 12.0427 18.7498 12.0852 18.7491 12.1275C18.742 12.5064 18.887 12.8782 19.1795 13.119L20.1839 13.9458C20.6085 14.2953 20.7181 14.9006 20.4432 15.3769L19.1462 17.6233C18.8712 18.0996 18.2922 18.3072 17.7772 18.1143L16.5604 17.6584C16.2048 17.5252 15.8095 17.5862 15.4844 17.7825C15.412 17.8263 15.3387 17.8687 15.2645 17.9097C14.9327 18.0934 14.6828 18.4049 14.6204 18.779L14.4069 20.06C14.3165 20.6025 13.8472 21.0001 13.2972 21.0001H10.7033C10.1533 21.0001 9.68397 20.6025 9.59356 20.06L9.38005 18.779C9.31771 18.4049 9.06774 18.0934 8.73597 17.9097C8.66179 17.8687 8.58847 17.8263 8.51604 17.7825C8.19101 17.5863 7.79568 17.5252 7.44011 17.6584L6.22325 18.1143C5.70826 18.3072 5.12926 18.0996 4.85429 17.6233L3.55731 15.3769C3.28234 14.9006 3.39199 14.2954 3.81657 13.9458L4.82092 13.119C5.11343 12.8782 5.25843 12.5064 5.25141 12.1276C5.25063 12.0852 5.25023 12.0427 5.25023 12.0001C5.25023 11.9575 5.25063 11.915 5.25141 11.8726C5.25843 11.4938 5.11343 11.122 4.82092 10.8812L3.81657 10.0544C3.39199 9.70484 3.28234 9.09958 3.55731 8.62332L4.85429 6.37688C5.12926 5.90061 5.70825 5.69295 6.22325 5.88588L7.4401 6.34176C7.79566 6.47496 8.19099 6.41394 8.51603 6.21767C8.58846 6.17393 8.66179 6.13151 8.73597 6.09045C9.06774 5.9068 9.31771 5.59523 9.38005 5.22119L9.59356 3.94014Z">
              </path>
              <path
                d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3432 10.3431 9.00001 12 9.00001C13.6569 9.00001 15 10.3432 15 12Z">
              </path>
            </svg>
            è®¾ç½®
          </button>
        </div>
      </div>
    </div>
    <main class="sentences" id="sentences"></main>
    <div id="playerLiveRegion" class="sr-only" aria-live="polite" role="status"></div>
    <div class="lesson-nav">
      <a id="prevLesson" class="btn-nav prev" href="#">ä¸Šä¸€è¯¾</a>
      <a id="nextLesson" class="btn-nav next" href="#">ä¸‹ä¸€è¯¾</a>
    </div>
    <!-- Bottom player bar -->
    <div class="bottom-player-bar" role="region" aria-label="æ’­æ”¾å™¨">
      <div class="player">
        <div class="custom-player">
          <audio id="player"></audio>
          <button id="playPauseBtn" class="play-btn" aria-label="æ’­æ”¾/æš‚åœ">
            <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z" />
            </svg>
            <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display:none">
              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
            </svg>
          </button>
          <div class="time-display" id="currentTime">0:00</div>
          <div class="progress-container">
            <div class="progress-bar" id="progressBar">
              <div class="progress-filled" id="progressFilled"></div>
            </div>
          </div>
          <div class="time-display" id="duration">0:00</div>
        </div>
      </div>
    </div>
    <footer>
      <p class="repo">
        <a class="gh-link" href="https://github.com/luzhenhua/NCE-Flow" target="_blank" rel="noopener"
          aria-label="GitHub repository">
          <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
            <path
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36 .09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8Z">
            </path>
          </svg>
        </a>
      </p>
      <p class="byline">Designed &amp; Maintained by <a href="https://luzhenhua.cn/" target="_blank"
          rel="noopener">Luzhenhua</a></p>
      <p class="version"><a href="https://github.com/luzhenhua/NCE-Flow/releases" target="_blank" rel="noopener">ç‰ˆæœ¬
          1.7.9</a><span id="pwaFooterInstall" class="pwa-footer-link" hidden> Â· <a href="#">å®‰è£…åº”ç”¨</a></span></p>
      <div class="footer-actions">
        <a class="footer-btn" href="about.html">å…³äº</a>
      </div>
    </footer>
  </div>
  <!-- Settings Overlay/Panel -->
  <div id="settingsOverlay" class="settings-overlay" hidden></div>
  <div id="settingsPanel" class="settings-panel modern-settings" role="dialog" aria-modal="true"
    aria-labelledby="settingsTitle" hidden>
    <div class="settings-header">
      <h2 id="settingsTitle">åå¥½è®¾ç½®</h2>
      <button id="settingsClose" class="icon-btn close-btn" aria-label="å…³é—­è®¾ç½®">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="settings-content-scroll">
      <!-- Section 1: Reading Mode (Hero Section) -->
      <div class="setting-section">
        <h3 class="section-title">é˜…è¯»æ¨¡å¼</h3>
        <div class="read-mode-grid" role="radiogroup" aria-label="é˜…è¯»æ¨¡å¼">
          <!-- Continuous -->
          <label class="bento-card mode-card">
            <input type="radio" id="readModeContinuous" name="readMode" value="continuous" checked>
            <div class="card-content">
              <div class="icon-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
              </div>
              <div class="text-box">
                <span class="card-title">è¿è¯»</span>
                <span class="card-desc">è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€å¥</span>
              </div>
              <div class="check-mark"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg></div>
            </div>
          </label>

          <!-- Single -->
          <label class="bento-card mode-card">
            <input type="radio" id="readModeSingle" name="readMode" value="single">
            <div class="card-content">
              <div class="icon-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </div>
              <div class="text-box">
                <span class="card-title">ç‚¹è¯»</span>
                <span class="card-desc">ç‚¹å‡»æ’­æ”¾å•å¥</span>
              </div>
              <div class="check-mark"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg></div>
            </div>
          </label>

          <!-- Listen -->
          <label class="bento-card mode-card">
            <input type="radio" id="readModeListen" name="readMode" value="listen">
            <div class="card-content">
              <div class="icon-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path
                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24">
                  </path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </div>
              <div class="text-box">
                <span class="card-title">å¬è¯»</span>
                <span class="card-desc">åŸæ–‡éšè—çº¯å¬åŠ›</span>
              </div>
              <div class="check-mark"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg></div>
            </div>
          </label>

          <!-- Shadow -->
          <label class="bento-card mode-card">
            <input type="radio" id="readModeShadow" name="readMode" value="shadow">
            <div class="card-content">
              <div class="icon-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                  <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                  <line x1="12" y1="19" x2="12" y2="23"></line>
                  <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
              </div>
              <div class="text-box">
                <span class="card-title">è·Ÿè¯»</span>
                <span class="card-desc">å•å¥å¾ªç¯å¤è¯»</span>
              </div>
              <div class="check-mark"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg></div>
            </div>
          </label>
        </div>
      </div>

      <!-- Section: Shadow Settings (Conditional) -->
      <div id="shadowSettingsGroup" class="setting-section" style="display:none;">
        <h3 class="section-title">è·Ÿè¯»é…ç½®</h3>
        <div class="bento-card full-card shadow-config-card">
          <div class="config-row">
            <span class="label">å¾ªç¯æ¬¡æ•°</span>
            <div class="stepper">
              <button id="shadowDec" class="stepper-btn" aria-label="å‡å°‘å¾ªç¯æ¬¡æ•°">âˆ’</button>
              <input id="shadowRepeat" class="stepper-input" type="number" value="2" readonly aria-label="å¾ªç¯æ¬¡æ•°">
              <button id="shadowInc" class="stepper-btn" aria-label="å¢åŠ å¾ªç¯æ¬¡æ•°">+</button>
            </div>
          </div>
          <div class="config-row border-top">
            <span class="label">è·Ÿè¯»é—´éš”</span>
            <div class="segmented-control small">
              <div id="shadowGapCard" style="display:contents">
                <label class="seg-option">
                  <input type="radio" id="shadowGapShort" name="shadowGap" value="short">
                  <span>çŸ­</span>
                </label>
                <label class="seg-option">
                  <input type="radio" id="shadowGapMedium" name="shadowGap" value="medium" checked>
                  <span>ä¸­</span>
                </label>
                <label class="seg-option">
                  <input type="radio" id="shadowGapLong" name="shadowGap" value="long">
                  <span>é•¿</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 2: Controls & Toggles -->
      <div class="setting-section">
        <h3 class="section-title">æ’­æ”¾æ§åˆ¶</h3>
        <div class="bento-grid-2">

          <!-- Playback Speed -->
          <div class="bento-card control-card">
            <div class="card-header">
              <span class="label">æ’­æ”¾é€Ÿåº¦</span>
              <span class="value-display" id="speedDisplay">1.0x</span>
            </div>
            <!-- Custom Segmented Control for Speed -->
            <div class="segmented-control speed-segments">
              <button class="seg-btn" data-rate="0.8" aria-label="0.8å€é€Ÿ">0.8</button>
              <button class="seg-btn active" data-rate="1.0" aria-label="1.0å€é€Ÿ">1.0</button>
              <button class="seg-btn" data-rate="1.2" aria-label="1.2å€é€Ÿ">1.2</button>
              <button class="seg-btn" data-rate="1.5" aria-label="1.5å€é€Ÿ">1.5</button>
              <button class="seg-btn" data-rate="2.0" aria-label="2.0å€é€Ÿ">2.0</button>
              <button class="seg-btn" data-rate="2.5" aria-label="2.5å€é€Ÿ">2.5</button>
              <!-- Hidden original button for compatibility if needed, or remove completely -->
              <button id="speed" hidden>Legacy</button>
            </div>
            <div class="speed-custom-row">
              <label class="speed-custom-label" for="speedCustomInput">æ‰‹åŠ¨</label>
              <div class="speed-custom-field">
                <input id="speedCustomInput" class="speed-custom-input" type="number" min="0.5" max="2.5" step="0.05"
                  inputmode="decimal" aria-label="æ‰‹åŠ¨è®¾ç½®æ’­æ”¾é€Ÿåº¦">
                <span class="speed-custom-unit">x</span>
              </div>
              <span class="speed-custom-hint">0.5 - 2.5</span>
            </div>
          </div>

          <!-- After Play Action -->
          <div class="bento-card control-card">
            <div class="card-header">
              <span class="label">æ’­å®Œå</span>
            </div>
            <div class="select-wrapper">
              <select id="afterPlaySelect" class="modern-select">
                <option value="none">ç»“æŸæ’­æ”¾</option>
                <option value="next">è‡ªåŠ¨ç»­é›†</option>
                <option value="single">å•å¥å¾ªç¯</option>
                <option value="all">æ•´ç¯‡å¾ªç¯</option>
              </select>
              <svg class="select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
              <!-- Hidden radios for JS compatibility -->
              <div style="display:none;" id="afterPlayCard">
                <input type="radio" id="afterPlaySingle" name="afterPlay" value="single">
                <input type="radio" id="afterPlayAll" name="afterPlay" value="all">
                <input type="radio" id="afterPlayNext" name="afterPlay" value="next">
                <input type="radio" id="afterPlayNone" name="afterPlay" value="none" checked>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Section 3: Toggles Row -->
      <div class="setting-section">
        <div class="toggles-list">

          <!-- Auto Scroll -->
          <div class="toggle-row">
            <div class="toggle-info">
              <span class="toggle-label">è‡ªåŠ¨è·Ÿéš</span>
              <span class="toggle-desc">æ’­æ”¾æ—¶é«˜äº®å¹¶æ»šåŠ¨åˆ°å½“å‰å¥</span>
            </div>
            <label class="switch">
              <!-- Using hidden radios to mimic checkbox behavior for compatibility or rewrite JS -->
              <!-- New strategy: Use a real checkbox for UI, and sync with hidden radios -->
              <input type="checkbox" id="followToggleCheckbox" checked>
              <span class="slider round"></span>
              <!-- Hidden radios for legacy JS -->
              <div style="display:none;" id="followCard">
                <input type="radio" id="followOn" name="autoFollow" value="true" checked>
                <input type="radio" id="followOff" name="autoFollow" value="false">
              </div>
            </label>
          </div>

          <!-- Skip Intro -->
          <div class="toggle-row border-top">
            <div class="toggle-info">
              <span class="toggle-label">è·³è¿‡å¼€å¤´</span>
              <span class="toggle-desc">è‡ªåŠ¨è·³è¿‡æ ‡é¢˜å’Œå¼•å¯¼è¯­</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="skipIntroCheckbox">
              <span class="slider round"></span>
              <!-- Hidden radios for legacy JS -->
              <div style="display:none;" id="skipIntroCard">
                <input type="radio" id="skipIntroOn" name="skipIntro" value="true">
                <input type="radio" id="skipIntroOff" name="skipIntro" value="false" checked>
              </div>
            </label>
          </div>

        </div>
      </div>

      <!-- Section 4: Shadow Settings (Removed: Moved to Section 1) -->

      <!-- Section: Data Management -->
      <div class="setting-section">
        <h3 class="section-title">æ•°æ®ç®¡ç†</h3>
        <div class="bento-card full-card">
          <button id="dataExportBtn" class="data-mgmt-row" type="button">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <div class="data-mgmt-text">
              <span class="data-mgmt-label">å¯¼å‡ºå¤‡ä»½</span>
              <span class="data-mgmt-desc">å°†æ”¶è—ã€è¿›åº¦å’Œè®¾ç½®ä¿å­˜ä¸º JSON æ–‡ä»¶</span>
            </div>
            <svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
          <div class="data-mgmt-divider"></div>
          <button id="dataImportBtn" class="data-mgmt-row" type="button">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <div class="data-mgmt-text">
              <span class="data-mgmt-label">å¯¼å…¥å¤‡ä»½</span>
              <span class="data-mgmt-desc">ä» JSON æ–‡ä»¶æ¢å¤æ•°æ®ï¼ˆå°†è¦†ç›–å½“å‰æ•°æ®ï¼‰</span>
            </div>
            <svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
          <input type="file" id="dataImportFile" accept=".json" hidden>
        </div>
      </div>

      <!-- Bottom Actions -->
      <div class="setting-section action-section">
        <button id="shortcutsToggle" class="action-btn" aria-label="æŸ¥çœ‹é”®ç›˜å¿«æ·é”®">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path
              d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z">
            </path>
          </svg>
          <span>é”®ç›˜å¿«æ·é”®</span>
          <svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>

    </div>

    <div class="settings-footer-modern">
      <button id="settingsReset" class="text-btn">æ¢å¤é»˜è®¤</button>
      <button id="settingsDone" class="primary-btn">å®Œæˆ</button>
    </div>
  </div>

  <!-- Shortcuts Help Panel -->
  <div id="shortcutsOverlay" class="settings-overlay" hidden></div>
  <div id="shortcutsPanel" class="settings-panel modern-settings" role="dialog" aria-modal="true"
    aria-labelledby="shortcutsTitle" hidden>
    <div class="settings-header">
      <h2 id="shortcutsTitle">å¿«æ·é”®</h2>
      <button id="shortcutsClose" class="icon-btn close-btn" aria-label="å…³é—­å¿«æ·é”®å¸®åŠ©">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="settings-content-scroll">
      <div class="shortcuts-tip-card bento-card"
        style="padding: 12px; display: flex; align-items: center; gap: 8px; background: var(--surface);">
        <svg style="width: 16px; height: 16px; color: var(--muted);" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span style="font-size: 13px; color: var(--muted);">ç‚¹å‡»æŒ‰é”®å¯è‡ªå®šä¹‰é…ç½®ï¼Œå†²çªæ—¶ä¼šæœ‰æç¤ºã€‚</span>
      </div>
      <div id="shortcutsContainer" class="shortcuts-grid-layout">
        <!-- ç”± JS åŠ¨æ€æ¸²æŸ“ -->
      </div>
    </div>

    <div class="settings-footer-modern">
      <button id="shortcutsReset" class="text-btn">æ¢å¤é»˜è®¤</button>
      <div style="flex:1"></div>
      <button id="shortcutsBack" class="text-btn" style="margin-right: 12px;">è¿”å›è®¾ç½®</button>
      <button id="shortcutsDone" class="primary-btn">å®Œæˆ</button>
    </div>
  </div>

  <!-- Auto Stop (Sleep Timer) Panel -->
  <div id="autoStopOverlay" class="settings-overlay" hidden></div>
  <div id="autoStopPanel" class="settings-panel modern-settings" role="dialog" aria-modal="true"
    aria-labelledby="autoStopTitle" hidden>
    <div class="settings-header">
      <h2 id="autoStopTitle">è‡ªåŠ¨å…³é—­</h2>
      <button id="autoStopClose" class="icon-btn close-btn" aria-label="å…³é—­è‡ªåŠ¨å…³é—­è®¾ç½®">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="settings-content-scroll">
      <!-- Enable Toggle -->
      <div class="setting-section">
        <div class="toggle-row bento-card" style="border-radius: 12px;">
          <div class="toggle-info">
            <span class="toggle-label">å¯ç”¨å®šæ—¶</span>
            <span class="toggle-desc">åœ¨è¿ç»­æ’­æ”¾æ•°è¯¾åè‡ªåŠ¨åœæ­¢</span>
          </div>
          <label class="switch">
            <input type="checkbox" id="autoStopToggleSync"> <!-- Sync via JS -->
            <span class="slider round"></span>
            <!-- Legacy Radios for JS compatibility -->
            <div id="autoStopCard" style="display:none;">
              <input type="radio" id="autoStopOn" name="autoStop" value="true">
              <input type="radio" id="autoStopOff" name="autoStop" value="false" checked>
            </div>
          </label>
        </div>
      </div>

      <!-- Count Config -->
      <div class="setting-section">
        <h3 class="section-title">è®¾ç½®æ—¶é•¿</h3>
        <div class="bento-card full-card">
          <div class="config-row">
            <span class="label">æŒç»­æ’­æ”¾</span>
            <div class="stepper">
              <button id="autoStopDecSync" class="stepper-btn" aria-label="å‡å°‘è¯¾æ•°">âˆ’</button>
              <input id="autoStopCount" class="stepper-input" type="number" min="1" max="50" value="3"
                aria-label="è¿ç»­æ’­æ”¾è¯¾æ•°">
              <button id="autoStopIncSync" class="stepper-btn" aria-label="å¢åŠ è¯¾æ•°">+</button>
            </div>
            <span class="label" style="font-size: 13px; color: var(--muted); margin-left: 4px;">è¯¾</span>
          </div>
        </div>
      </div>
    </div>

    <div class="settings-footer-modern">
      <button id="autoStopCancel" class="text-btn">å–æ¶ˆ</button>
      <button id="autoStopSave" class="primary-btn">ä¿å­˜</button>
    </div>
  </div>

  <script>
    // æ³¨å†Œ Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then((reg) => {
            console.log('[PWA] Service Worker æ³¨å†ŒæˆåŠŸ');
            reg.update();

            if (reg.waiting) {
              reg.waiting.postMessage({ type: 'SKIP_WAITING' });
            }

            reg.addEventListener('updatefound', () => {
              const newWorker = reg.installing;
              if (!newWorker) return;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  newWorker.postMessage({ type: 'SKIP_WAITING' });
                }
              });
            });

            // Show update notification instead of auto-refresh
            navigator.serviceWorker.addEventListener('controllerchange', () => {
              showUpdateNotification();
            });
          })
          .catch(err => console.log('[PWA] Service Worker æ³¨å†Œå¤±è´¥:', err));
      });
    }

    function showUpdateNotification() {
      if (document.getElementById('updateNotification')) return;
      const notification = document.createElement('div');
      notification.id = 'updateNotification';
      notification.className = 'update-toast';
      notification.innerHTML = `<span class="update-toast-text">ğŸ‰ æ–°ç‰ˆæœ¬å·²å°±ç»ª</span><button class="update-toast-btn" onclick="window.location.reload()">åˆ·æ–°</button>`;
      document.body.appendChild(notification);
    }
  </script>

  <!-- PWA Install Prompt -->
  <div id="pwaPrompt" class="pwa-prompt">
    <img src="icons/icon-192x192.png" alt="" class="pwa-prompt-icon">
    <div class="pwa-prompt-content">
      <span class="pwa-prompt-title">å®‰è£… NCE Flow</span>
      <span class="pwa-prompt-sub" id="pwaPromptSub">æ·»åŠ åˆ°ä¸»å±å¹•ï¼Œéšæ—¶å­¦ä¹ </span>
    </div>
    <button id="pwaInstall" class="pwa-prompt-btn">å®‰è£…</button>
    <button id="pwaClose" class="pwa-prompt-close" type="button" aria-label="å…³é—­å®‰è£…æç¤º" tabindex="0">Ã—</button>
  </div>
  <!-- Back to top -->
  <button id="backToTop" class="back-to-top" type="button" aria-label="å›åˆ°é¡¶ç«¯" title="å›åˆ°é¡¶ç«¯">
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="1.8"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 5v14"></path>
      <polyline points="6 11 12 5 18 11"></polyline>
    </svg>
  </button>
  <script>
    (function () {
      const DISMISS_KEY = 'pwa_dismissed';
      const INSTALLED_KEY = 'pwa_installed';
      let deferredPrompt = null;
      const el = document.getElementById('pwaPrompt');
      const installBtn = document.getElementById('pwaInstall');
      const closeBtn = document.getElementById('pwaClose');
      const promptSub = document.getElementById('pwaPromptSub');
      const footerInstall = document.getElementById('pwaFooterInstall');
      if (!el) return;

      // æ£€æµ‹ iOS Safari
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome|CriOS|FxiOS/.test(navigator.userAgent);
      const isIOSSafari = isIOS && isSafari;
      const isStandalone = window.matchMedia('(display-mode:standalone)').matches || navigator.standalone;

      const isInstalled = () => isStandalone || localStorage.getItem(INSTALLED_KEY);
      const isDismissed = () => { const d = localStorage.getItem(DISMISS_KEY); return d && (Date.now() - parseInt(d)) < 7 * 24 * 60 * 60 * 1000; };

      const showPrompt = () => {
        if (isInstalled() || isDismissed()) return;
        if (!deferredPrompt && !isIOSSafari) return;
        el.classList.add('show');
      };
      const hidePrompt = () => el.classList.remove('show');
      const showFooterLink = () => { if (footerInstall && !isInstalled()) footerInstall.hidden = false; };
      const hideFooterLink = () => { if (footerInstall) footerInstall.hidden = true; };

      // iOS å¼•å¯¼ç•Œé¢
      const showIOSGuide = () => {
        el.classList.add('ios-prompt');
        promptSub.innerHTML = 'ç‚¹å‡»åº•éƒ¨ <svg class="ios-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg> ç„¶åé€‰æ‹©ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€';
        installBtn.textContent = 'çŸ¥é“äº†';
        installBtn.onclick = hidePrompt;
      };

      const doInstall = async () => {
        // iOS Safari: ç‚¹å‡»åæ˜¾ç¤ºå¼•å¯¼
        if (isIOSSafari) {
          showIOSGuide();
          return;
        }
        // Chrome/Edge: æ ‡å‡†å®‰è£…æµç¨‹
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') localStorage.setItem(INSTALLED_KEY, '1');
        deferredPrompt = null;
        hidePrompt();
        hideFooterLink();
      };

      // iOS Safari: å»¶è¿Ÿæ˜¾ç¤ºæç¤ºï¼ˆä¸ Android ç›¸åŒçš„åˆå§‹ç•Œé¢ï¼‰
      if (isIOSSafari && !isInstalled() && !isDismissed()) {
        showFooterLink();
        setTimeout(showPrompt, 2500);
      }

      // Chrome/Edge: æ ‡å‡†å®‰è£…æµç¨‹
      window.addEventListener('beforeinstallprompt', e => {
        e.preventDefault();
        deferredPrompt = e;
        showFooterLink();
        setTimeout(showPrompt, 2500);
      });

      installBtn.addEventListener('click', doInstall);
      if (footerInstall) {
        footerInstall.querySelector('a').addEventListener('click', e => {
          e.preventDefault();
          showPrompt();
        });
      }
      closeBtn.addEventListener('click', () => { localStorage.setItem(DISMISS_KEY, Date.now()); hidePrompt(); });
      window.addEventListener('appinstalled', () => { localStorage.setItem(INSTALLED_KEY, '1'); hidePrompt(); hideFooterLink(); });
    })();
  </script>
</body>

</html>
